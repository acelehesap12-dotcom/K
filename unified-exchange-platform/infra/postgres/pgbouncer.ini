-- ============================================
-- PgBouncer Configuration for KK99 Exchange
-- ============================================

[databases]
exchange_db = host=postgres port=5432 dbname=exchange_db
timescale_db = host=timescaledb port=5432 dbname=timescale_db

[pgbouncer]
; Connection pooling mode
; - session: one server connection per client connection
; - transaction: server connection returned after transaction
; - statement: most aggressive, connections returned after each statement
pool_mode = transaction

; Maximum number of client connections
max_client_conn = 2000

; Default pool size per user/database pair
default_pool_size = 50

; Reserve pool for high-priority connections
reserve_pool_size = 10
reserve_pool_timeout = 5

; Maximum connections to a database
max_db_connections = 200

; Maximum connections per user
max_user_connections = 100

; Server connection lifetime
server_lifetime = 3600

; Server connection idle timeout
server_idle_timeout = 600

; Query timeout
query_timeout = 30

; Client idle timeout
client_idle_timeout = 300

; DNS lookup caching
dns_max_ttl = 15
dns_zone_check_period = 0

; Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

; Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

; Statistics
stats_period = 60

; Admin console
admin_users = pgbouncer_admin
stats_users = pgbouncer_stats

; Listen address
listen_addr = 0.0.0.0
listen_port = 6432

; Unix socket
unix_socket_dir = /var/run/pgbouncer

; TLS/SSL
;client_tls_sslmode = require
;client_tls_ca_file = /etc/pgbouncer/root.crt
;client_tls_key_file = /etc/pgbouncer/server.key
;client_tls_cert_file = /etc/pgbouncer/server.crt

; Performance tuning
; Disable statement-level stats for better performance
track_extra_parameters = 0

; Application name passthrough
application_name_add_host = 1

; Ignore startup parameters from client
ignore_startup_parameters = extra_float_digits,options

; Maximum prepared statements per connection
max_prepared_statements = 100

; SO_REUSEPORT for better connection distribution
so_reuseport = 1

; TCP keepalive
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 10
tcp_keepcnt = 5

; Buffer sizes
pkt_buf = 8192
listen_backlog = 512

; Disable JIT for pgbouncer queries
;server_reset_query = DISCARD ALL; SET jit = off;

[users]
; User-specific settings can be defined here
; exchange_user = pool_size=100
